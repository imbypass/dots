#!/bin/bash
source harmony-color-codes

TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)

screenrecording_toggle_indicator() {
    pkill -RTMIN+8 waybar
}
screenrecording_active() {
    pgrep -x gpu-screen.* >/dev/null || pgrep -x wl-screenrec >/dev/null || pgrep -x wf-recorder >/dev/null
}

screenrecording_start() {
    notify-send -u normal -a gpu-screen-recorder -t 2750 "Screen Recorder" "Recording started!"
    # cd "/home/${USER}/Videos/Screen Recordings/" && \
    #     wf-recorder -c libx264 -p crf=23 -p preset=medium -x yuv444p -f "${TIMESTAMP}.mp4" &

    gpu-screen-recorder -w HDMI-A-1 -c mp4 -k h264 -ac opus -f 60 -cursor no \
        -restore-portal-session yes -cr limited -encoder cpu -q very_high -a device:default_output \
        -o "/home/bypass/Videos/Screen Recordings/${TIMESTAMP}.mp4" &

    screenrecording_toggle_indicator
}

screenrecording_stop() {
    # kill -s INT $(pidof wf-recorder)
    kill -s INT $(pidof gpu-screen-recorder)
    notify-send -u normal -a gpu-screen-recorder -t 2750 "Screen Recorder" "Recording stopped!\nRecording saved as: ${TIMESTAMP}.mp4"

    sleep 0.2
    screenrecording_toggle_indicator
}

if [[ $1 == "start" ]];then
    screenrecording_start $2
elif [[ $1 == "stop" ]];then
    screenrecording_stop
else
    if screenrecording_active; then
        screenrecording_stop
    else
        screenrecording_start "--no-audio"
    fi
fi
